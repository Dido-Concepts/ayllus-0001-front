---
import type { PublicacionDestacadoData } from '@src/context/publicaciones/interfaces/publicacion'
import { publicacionContentService } from '@src/context/publicaciones/services/publicacionContent.service'
import FacebookIcon from '@src/components/icons/Facebook.icon.astro'
import ClipboardCopyIcon from '@src/components/icons/ClipboardCopy.icon.astro'
import Layout from '@src/layouts/Layout.astro'
import { SEO } from 'astro-seo'

const { slug } = Astro.params

let publicacion: PublicacionDestacadoData

try {
  publicacion = await publicacionContentService({ slug })

  if (publicacion.contenido === undefined) {
    return Astro.redirect('/publicaciones')
  }
} catch {
  return Astro.redirect('/publicaciones')
}

const date = new Date(publicacion.publishedAt || Date.now())
const options: Intl.DateTimeFormatOptions = {
  day: 'numeric',
  month: 'long',
  year: 'numeric'
}
const formatter = new Intl.DateTimeFormat('es-PE', options)
const formattedDate: string = formatter.format(date)

const urlCurrent = Astro.request.url

const shareFacebook = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(urlCurrent)}`

---

<Layout title={publicacion.titulo}>

    <SEO
        description={publicacion.descripcion}
        openGraph={{
          basic: {
            title: publicacion.titulo,
            type: 'article',
            image: publicacion.imagen.url
          }
        }}
        extend={{
          link: [{ rel: 'icon', href: '/favicon.ico' }],
          meta: [
            {
              name: 'twitter:image',
              content: publicacion.imagen.url
            },
            { name: 'twitter:title', content: publicacion.titulo },
            { name: 'twitter:description', content: publicacion.descripcion }
          ]
        }}
        slot={'head'}
    />

    <main class="mt-20 sm:mt-36 xl:mt-44">
        <section
            class="max-w-screen-xl rounded-xl border-2 border-[#CFCFD7] mx-auto my-10 px-10 py-8 flex flex-col gap-10"
        >
            <p class="text-ayllus-secondary font-medium">
                Publicado el {formattedDate}
            </p>

            <div class="text-black">
                <h1 class="text-4xl font-bold text-ayllus-primary">
                    {publicacion.titulo}
                </h1>
                <br />
                {
                    publicacion.contenido.map((item) => {
                      if (item.type === 'paragraph') {
                        return item.children.map((child) =>
                          child.text === ''
                            ? (
                                    <br />
                                    <br />
                              )
                            : (
                                    <p>{child.text}</p>
                              )
                        )
                      }

                      if (item.type === 'quote') {
                        return (
                                <blockquote class="relative p-8 bg-white rounded-lg shadow-lg border-l-4 border-ayllus-secondary">
                                    <p class="text-lg italic text-gray-700">
                                        "El único modo de hacer un gran trabajo
                                        es amar lo que haces. Si no lo has
                                        encontrado aún, sigue buscando. No te
                                        conformes."
                                    </p>
                                </blockquote>
                        )
                      }

                      if (item.type === 'image') {
                        return (
                                <img
                                    src={item.image?.url}
                                    alt={publicacion.titulo}
                                    class="w-full h-auto"
                                />
                        )
                      }

                      if (item.type === 'heading') {
                        if (item.level === 1) {
                          return (
                            <h2 class="text-3xl font-bold text-ayllus-primary">
                              {item.children[0].text}
                            </h2>
                          )
                        }

                        if (item.level === 2) {
                          return (
                            <h3 class="text-2xl font-bold text-ayllus-primary">
                              {item.children[0].text}
                            </h3>
                          )
                        }

                        if (item.level === 3) {
                          return (
                            <h4 class="text-xl font-bold text-ayllus-primary">
                              {item.children[0].text}
                            </h4>
                          )
                        }

                        if (item.level === 4) {
                          return (
                            <h5 class="text-lg font-bold text-ayllus-primary">
                              {item.children[0].text}
                            </h5>
                          )
                        }

                        if (item.level === 5) {
                          return (
                            <h6 class="text-base font-bold text-ayllus-primary">
                              {item.children[0].text}
                            </h6>
                          )
                        }

                        if (item.level === 6) {
                          return (
                            <h6 class="text-sm font-bold text-ayllus-primary">
                              {item.children[0].text}
                            </h6>
                          )
                        }
                      }

                      return ''
                    })
                }
            </div>

            <div class="border-y-2 border-[#CFCFD7] py-6 px-4 flex flex-col md:flex-row md:justify-between justify-center items-center gap-6">
                <div class="flex gap-4 items-center">
                    <a href={shareFacebook} target="_blank" rel="noopener noreferrer">
                        <FacebookIcon class="w-8 h-8 text-ayllus-secondary" />
                    </a>
                    <button id="copyButton">
                        <ClipboardCopyIcon class="w-7 h-7 text-ayllus-secondary" />
                    </button>
                </div>
                <h3 class="text-[#CFCFD7] text-xl">PUBLICACION</h3>
            </div>
        </section>
    </main>
</Layout>

<script>
const copyButton = document.getElementById('copyButton')

copyButton!.addEventListener('click', () => {
  const currentUrl = window.location.href

  navigator.clipboard.writeText(currentUrl)
    .then(() => {
      copyButton!.innerText = '¡URL copiada!'

      setTimeout(() => {
        copyButton!.innerHTML = `
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width=24
            height=24
            class="w-7 h-7 text-ayllus-secondary"
            viewBox="0 0 14 14"
          >
            <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
              <path d="M8.5 3.5v-1a1 1 0 0 0-1-1h-1m-2.5 9H1.5a1 1 0 0 1-1-1v-7a1 1 0 0 1 1-1h1"></path>
              <rect width="7" height="8" x="6.5" y="5.5" rx="1"></rect>
              <path d="M6.75.5h-4.5l.41 1.62a.49.49 0 0 0 .48.38h2.72a.49.49 0 0 0 .48-.38Zm1.75 8h3m-3 2h3"></path>
            </g>
          </svg>
        `
      }, 2000)
    })
    .catch(err => {
      console.error('Error al copiar la URL: ', err)
    })
})
</script>
